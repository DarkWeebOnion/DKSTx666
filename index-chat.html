/* دالة مراسلة تشبه فيسبوك (محلية تعمل بالمتصفح عبر localStorage فقط) */
(function (root) {
  const STORE_KEY_USERS   = "fb_like_users";
  const STORE_KEY_THREADS = "fb_like_threads";
  const STORE_KEY_MSGS    = "fb_like_messages";
  const STORE_KEY_SELF    = "fb_like_self";
  const EMIT_DELAY = 0; // ms

  const genId = (p="id") => `${p}_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;

  const read = (k, d) => {
    try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(d)); }
    catch { return d; }
  };
  const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  class Emitter {
    constructor(){ this.map = {}; }
    on(ev, fn){ (this.map[ev] ||= new Set()).add(fn); return () => this.off(ev, fn); }
    off(ev, fn){ this.map[ev]?.delete(fn); }
    emit(ev, payload){ setTimeout(()=> this.map[ev]?.forEach(fn=>fn(payload)), EMIT_DELAY); }
  }

  class ChatCore {
    constructor(){
      this.em = new Emitter();
      this.self = read(STORE_KEY_SELF, null);
      this.users = read(STORE_KEY_USERS, []);
      this.threads = read(STORE_KEY_THREADS, []);
      this.messages = read(STORE_KEY_MSGS, {}); // {threadId: Message[]}
    }

    /* ====== حساب المستخدم ====== */
    setSelf(user){ 
      // user = {id, name, avatar}
      this.self = user; 
      write(STORE_KEY_SELF, user);
      if (!this.users.find(u=>u.id===user.id)){
        this.users.push(user); 
        write(STORE_KEY_USERS, this.users);
      }
      this.em.emit("auth:change", user);
      return user;
    }
    getSelf(){ return this.self; }
    addUser(user){ 
      if (!this.users.find(u=>u.id===user.id)){ 
        this.users.push(user); 
        write(STORE_KEY_USERS, this.users);
        this.em.emit("user:add", user);
      }
      return user;
    }
    getUser(id){ return this.users.find(u=>u.id===id)||null; }
    listUsers(q=""){ 
      const s=q.trim().toLowerCase(); 
      return this.users.filter(u=>!s || u.name.toLowerCase().includes(s)); 
    }

    /* ====== المحادثات (خاص + مجموعات) ====== */
    createThread({type="dm", members=[], name="", avatar=""}){
      if (type==="dm" && members.length!==2) throw new Error("محادثة خاصة تحتاج عضوين فقط");
      const id = genId("thread");
      const t = { id, type, members: Array.from(new Set(members)), name, avatar, createdAt: Date.now(), meta:{
        allowNick:true, allowImage:true, allowName:true, allowAdd:true
      }};
      this.threads.unshift(t);
      write(STORE_KEY_THREADS, this.threads);
      this.messages[id] = [];
      write(STORE_KEY_MSGS, this.messages);
      this.em.emit("thread:create", t);
      return t;
    }
    listThreads(){ return this.threads.slice(); }
    getThread(id){ return this.threads.find(t=>t.id===id)||null; }
    setThreadMeta(id, meta){ 
      const t=this.getThread(id); if(!t) return null;
      t.meta = {...t.meta, ...meta};
      write(STORE_KEY_THREADS, this.threads);
      this.em.emit("thread:update", t);
      return t;
    }
    addMembers(threadId, memberIds=[]){
      const t=this.getThread(threadId); if(!t) return null;
      t.members = Array.from(new Set([...(t.members||[]), ...memberIds]));
      write(STORE_KEY_THREADS, this.threads);
      this.em.emit("thread:members", {threadId, members:t.members});
      return t.members;
    }
    removeMember(threadId, userId){
      const t=this.getThread(threadId); if(!t) return null;
      t.members = t.members.filter(id=>id!==userId);
      write(STORE_KEY_THREADS, this.threads);
      this.em.emit("thread:members", {threadId, members:t.members});
      return t.members;
    }

    /* ====== الرسائل ====== */
    sendMessage({threadId, text="", attachments=[]}){
      if(!this.self) throw new Error("لا يوجد مستخدم مسجل");
      const t=this.getThread(threadId); if(!t) throw new Error("محادثة غير موجودة");
      const m = {
        id: genId("msg"),
        threadId,
        from: this.self.id,
        text,
        attachments: attachments.map(a=>({ id: genId("att"), kind:a.kind, src:a.src, name:a.name||"" })), // kind: "image"|"video"|"gif"|"file"
        reactions: {}, // emoji -> [userIds]
        reads: [], // userIds
        createdAt: Date.now()
      };
      (this.messages[threadId] ||= []).push(m);
      write(STORE_KEY_MSGS, this.messages);
      this.em.emit("message:new", m);
      return m;
    }
    getMessages(threadId, limit=200){
      const arr = this.messages[threadId]||[];
      return arr.slice(Math.max(0, arr.length - limit));
    }
    react(messageId, threadId, emoji, userId){
      const msgs = this.messages[threadId]||[];
      const m = msgs.find(x=>x.id===messageId); if(!m) return null;
      m.reactions[emoji] ||= [];
      if(!m.reactions[emoji].includes(userId)) m.reactions[emoji].push(userId);
      write(STORE_KEY_MSGS, this.messages);
      this.em.emit("message:react", {threadId, messageId, emoji, users:m.reactions[emoji]});
      return m.reactions;
    }
    unreact(messageId, threadId, emoji, userId){
      const msgs = this.messages[threadId]||[];
      const m = msgs.find(x=>x.id===messageId); if(!m) return null;
      if(m.reactions[emoji]) m.reactions[emoji] = m.reactions[emoji].filter(id=>id!==userId);
      write(STORE_KEY_MSGS, this.messages);
      this.em.emit("message:react", {threadId, messageId, emoji, users:m.reactions[emoji]||[]});
      return m.reactions;
    }
    markRead(threadId, messageId, userId){
      const msgs = this.messages[threadId]||[];
      const m = msgs.find(x=>x.id===messageId); if(!m) return null;
      if(!m.reads.includes(userId)) m.reads.push(userId);
      write(STORE_KEY_MSGS, this.messages);
      this.em.emit("message:read", {threadId, messageId, userId});
      return m.reads;
    }
    deleteMessage(threadId, messageId){
      const msgs = this.messages[threadId]||[];
      const i = msgs.findIndex(x=>x.id===messageId);
      if(i>=0){ msgs.splice(i,1); write(STORE_KEY_MSGS, this.messages); this.em.emit("message:delete",{threadId,messageId}); }
      return true;
    }

    /* ====== حالة الكتابة و آخر ظهور ====== */
    setTyping(threadId, userId, typing=true){
      this.em.emit("typing", {threadId, userId, typing});
    }
    setPresence(userId, status="online"){ // "online"|"offline"
      this.em.emit("presence", {userId, status, at:Date.now()});
    }

    /* ====== أدوات ====== */
    threadForDM(a,b){
      const ids = [a,b].sort().join("_");
      let t = this.threads.find(t=>t.type==="dm" && new Set(t.members).size===2 && t.members.sort().join("_")===ids);
      if(!t) t=this.createThread({type:"dm", members:[a,b]});
      return t;
    }
    clearAll(){
      this.users=[]; this.threads=[]; this.messages={}; this.self=null;
      write(STORE_KEY_USERS,this.users); write(STORE_KEY_THREADS,this.threads); write(STORE_KEY_MSGS,this.messages); localStorage.removeItem(STORE_KEY_SELF);
      this.em.emit("reset", true);
    }

    /* ====== أحداث ====== */
    on(ev, fn){ return this.em.on(ev, fn); }
    off(ev, fn){ return this.em.off(ev, fn); }
  }

  const api = new ChatCore();

  /* واجهة عامة مبسطة */
  const ChatAPI = {
    on: (...a)=>api.on(...a),
    off: (...a)=>api.off(...a),

    setSelf: (u)=>api.setSelf(u),
    getSelf: ()=>api.getSelf(),

    addUser: (u)=>api.addUser(u),
    getUser: (id)=>api.getUser(id),
    listUsers: (q)=>api.listUsers(q),

    createThread: (opts)=>api.createThread(opts),
    listThreads: ()=>api.listThreads(),
    getThread: (id)=>api.getThread(id),
    setThreadMeta: (id, meta)=>api.setThreadMeta(id, meta),
    addMembers: (id, ids)=>api.addMembers(id, ids),
    removeMember: (id, uid)=>api.removeMember(id, uid),
    threadForDM: (a,b)=>api.threadForDM(a,b),

    sendMessage: (payload)=>api.sendMessage(payload),
    getMessages: (threadId, limit)=>api.getMessages(threadId, limit),
    react: (mid, tid, emoji, uid)=>api.react(mid, tid, emoji, uid),
    unreact: (mid, tid, emoji, uid)=>api.unreact(mid, tid, emoji, uid),
    markRead: (tid, mid, uid)=>api.markRead(tid, mid, uid),
    deleteMessage: (tid, mid)=>api.deleteMessage(tid, mid),

    setTyping: (tid, uid, t)=>api.setTyping(tid, uid, t),
    setPresence: (uid, st)=>api.setPresence(uid, st),

    clearAll: ()=>api.clearAll()
  };

  root.FBLikeChat = ChatAPI;
})(window);

/* مثال تهيئة سريع (يمكن حذف هذا الجزء إن أردت)
window.FBLikeChat.setSelf({id:"me_1", name:"أنا", avatar:"me.png"});
window.FBLikeChat.addUser({id:"u_2", name:"Shadow", avatar:"shadow.png"});
const t = FBLikeChat.threadForDM("me_1","u_2");
FBLikeChat.sendMessage({threadId:t.id, text:"مرحبا", attachments:[]});
*/

