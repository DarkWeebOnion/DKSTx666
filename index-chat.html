
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>دردشة محلية شبيهة بالفيسبوك</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #1877f2;
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }
    #chat-container {
      flex: 1;
      display: flex;
      padding: 10px;
      gap: 10px;
    }
    #threads {
      width: 200px;
      background: white;
      border: 1px solid #ccc;
      overflow-y: auto;
    }
    #messages {
      flex: 1;
      background: white;
      border: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }
    #message-list {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }
    #send-box {
      display: flex;
      padding: 5px;
      border-top: 1px solid #ccc;
    }
    #send-box input {
      flex: 1;
      padding: 5px;
    }
    #send-box button {
      padding: 5px 10px;
      background: #1877f2;
      color: white;
      border: none;
      cursor: pointer;
    }
    .message {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 5px;
    }
    .mine {
      background: #d1e7ff;
      align-self: flex-end;
    }
    .theirs {
      background: #e4e6eb;
      align-self: flex-start;
    }
  </style>
</head>
<body>

<header>دردشة محلية</header>

<div id="chat-container">
  <div id="threads"></div>
  <div id="messages">
    <div id="message-list"></div>
    <div id="send-box">
      <input type="text" id="msgInput" placeholder="اكتب رسالة...">
      <button id="sendBtn">إرسال</button>
    </div>
  </div>
</div>

<script>
/* ====== الكود الذي أرسلته ====== */
(function (root) {
  const STORE_KEY_USERS   = "fb_like_users";
  const STORE_KEY_THREADS = "fb_like_threads";
  const STORE_KEY_MSGS    = "fb_like_messages";
  const STORE_KEY_SELF    = "fb_like_self";
  const EMIT_DELAY = 0;

  const genId = (p="id") => `${p}_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;

  const read = (k, d) => {
    try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(d)); }
    catch { return d; }
  };
  const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  class Emitter {
    constructor(){ this.map = {}; }
    on(ev, fn){ (this.map[ev] ||= new Set()).add(fn); return () => this.off(ev, fn); }
    off(ev, fn){ this.map[ev]?.delete(fn); }
    emit(ev, payload){ setTimeout(()=> this.map[ev]?.forEach(fn=>fn(payload)), EMIT_DELAY); }
  }

  class ChatCore {
    constructor(){
      this.em = new Emitter();
      this.self = read(STORE_KEY_SELF, null);
      this.users = read(STORE_KEY_USERS, []);
      this.threads = read(STORE_KEY_THREADS, []);
      this.messages = read(STORE_KEY_MSGS, {});
    }

    setSelf(user){ 
      this.self = user; 
      write(STORE_KEY_SELF, user);
      if (!this.users.find(u=>u.id===user.id)){
        this.users.push(user); 
        write(STORE_KEY_USERS, this.users);
      }
      this.em.emit("auth:change", user);
      return user;
    }
    getSelf(){ return this.self; }
    addUser(user){ 
      if (!this.users.find(u=>u.id===user.id)){ 
        this.users.push(user); 
        write(STORE_KEY_USERS, this.users);
        this.em.emit("user:add", user);
      }
      return user;
    }
    getUser(id){ return this.users.find(u=>u.id===id)||null; }
    listUsers(q=""){ 
      const s=q.trim().toLowerCase(); 
      return this.users.filter(u=>!s || u.name.toLowerCase().includes(s)); 
    }

    createThread({type="dm", members=[], name="", avatar=""}){
      if (type==="dm" && members.length!==2) throw new Error("محادثة خاصة تحتاج عضوين فقط");
      const id = genId("thread");
      const t = { id, type, members: Array.from(new Set(members)), name, avatar, createdAt: Date.now(), meta:{
        allowNick:true, allowImage:true, allowName:true, allowAdd:true
      }};
      this.threads.unshift(t);
      write(STORE_KEY_THREADS, this.threads);
      this.messages[id] = [];
      write(STORE_KEY_MSGS, this.messages);
      this.em.emit("thread:create", t);
      return t;
    }
    listThreads(){ return this.threads.slice(); }
    getThread(id){ return this.threads.find(t=>t.id===id)||null; }
    setThreadMeta(id, meta){ 
      const t=this.getThread(id); if(!t) return null;
      t.meta = {...t.meta, ...meta};
      write(STORE_KEY_THREADS, this.threads);
      this.em.emit("thread:update", t);
      return t;
    }
    addMembers(threadId, memberIds=[]){
      const t=this.getThread(threadId); if(!t) return null;
      t.members = Array.from(new Set([...(t.members||[]), ...memberIds]));
      write(STORE_KEY_THREADS, this.threads);
      this.em.emit("thread:members", {threadId, members:t.members});
      return t.members;
    }
    removeMember(threadId, userId){
      const t=this.getThread(threadId); if(!t) return null;
      t.members = t.members.filter(id=>id!==userId);
      write(STORE_KEY_THREADS, this.threads);
      this.em.emit("thread:members", {threadId, members:t.members});
      return t.members;
    }

    sendMessage({threadId, text="", attachments=[]}){
      if(!this.self) throw new Error("لا يوجد مستخدم مسجل");
      const t=this.getThread(threadId); if(!t) throw new Error("محادثة غير موجودة");
      const m = {
        id: genId("msg"),
        threadId,
        from: this.self.id,
        text,
        attachments: attachments.map(a=>({ id: genId("att"), kind:a.kind, src:a.src, name:a.name||"" })),
        reactions: {},
        reads: [],
        createdAt: Date.now()
      };
      (this.messages[threadId] ||= []).push(m);
      write(STORE_KEY_MSGS, this.messages);
      this.em.emit("message:new", m);
      return m;
    }
    getMessages(threadId, limit=200){
      const arr = this.messages[threadId]||[];
      return arr.slice(Math.max(0, arr.length - limit));
    }
    react(messageId, threadId, emoji, userId){
      const msgs = this.messages[threadId]||[];
      const m = msgs.find(x=>x.id===messageId); if(!m) return null;
      m.reactions[emoji] ||= [];
      if(!m.reactions[emoji].includes(userId)) m.reactions[emoji].push(userId);
      write(STORE_KEY_MSGS, this.messages);
      this.em.emit("message:react", {threadId, messageId, emoji, users:m.reactions[emoji]});
      return m.reactions;
    }
    unreact(messageId, threadId, emoji, userId){
      const msgs = this.messages[threadId]||[];
      const m = msgs.find(x=>x.id===messageId); if(!m) return null;
      if(m.reactions[emoji]) m.reactions[emoji] = m.reactions[emoji].filter(id=>id!==userId);
      write(STORE_KEY_MSGS, this.messages);
      this.em.emit("message:react", {threadId, messageId, emoji, users:m.reactions[emoji]||[]});
      return m.reactions;
    }
    markRead(threadId, messageId, userId){
      const msgs = this.messages[threadId]||[];
      const m = msgs.find(x=>x.id===messageId); if(!m) return null;
      if(!m.reads.includes(userId)) m.reads.push(userId);
      write(STORE_KEY_MSGS, this.messages);
      this.em.emit("message:read", {threadId, messageId, userId});
      return m.reads;
    }
    deleteMessage(threadId, messageId){
      const msgs = this.messages[threadId]||[];
      const i = msgs.findIndex(x=>x.id===messageId);
      if(i>=0){ msgs.splice(i,1); write(STORE_KEY_MSGS, this.messages); this.em.emit("message:delete",{threadId,messageId}); }
      return true;
    }

    setTyping(threadId, userId, typing=true){
      this.em.emit("typing", {threadId, userId, typing});
    }
    setPresence(userId, status="online"){
      this.em.emit("presence", {userId, status, at:Date.now()});
    }

    threadForDM(a,b){
      const ids = [a,b].sort().join("_");
      let t = this.threads.find(t=>t.type==="dm" && new Set(t.members).size===2 && t.members.sort().join("_")===ids);
      if(!t) t=this.createThread({type:"dm", members:[a,b]});
      return t;
    }
    clearAll(){
      this.users=[]; this.threads=[]; this.messages={}; this.self=null;
      write(STORE_KEY_USERS,this.users); write(STORE_KEY_THREADS,this.threads); write(STORE_KEY_MSGS,this.messages); localStorage.removeItem(STORE_KEY_SELF);
      this.em.emit("reset", true);
    }

    on(ev, fn){ return this.em.on(ev, fn); }
    off(ev, fn){ return this.em.off(ev, fn); }
  }

  const api = new ChatCore();

  const ChatAPI = {
    on: (...a)=>api.on(...a),
    off: (...a)=>api.off(...a),
    setSelf: (u)=>api.setSelf(u),
    getSelf: ()=>api.getSelf(),
    addUser: (u)=>api.addUser(u),
    getUser: (id)=>api.getUser(id),
    listUsers: (q)=>api.listUsers(q),
    createThread: (opts)=>api.createThread(opts),
    listThreads: ()=>api.listThreads(),
    getThread: (id)=>api.getThread(id),
    setThreadMeta: (id, meta)=>api.setThreadMeta(id, meta),
    addMembers: (id, ids)=>api.addMembers(id, ids),
    removeMember: (id, uid)=>api.removeMember(id, uid),
    threadForDM: (a,b)=>api.threadForDM(a,b),
    sendMessage: (payload)=>api.sendMessage(payload),
    getMessages: (threadId, limit)=>api.getMessages(threadId, limit),
    react: (mid, tid, emoji, uid)=>api.react(mid, tid, emoji, uid),
    unreact: (mid, tid, emoji, uid)=>api.unreact(mid, tid, emoji, uid),
    markRead: (tid, mid, uid)=>api.markRead(tid, mid, uid),
    deleteMessage: (tid, mid)=>api.deleteMessage(tid, mid),
    setTyping: (tid, uid, t)=>api.setTyping(tid, uid, t),
    setPresence: (uid, st)=>api.setPresence(uid, st),
    clearAll: ()=>api.clearAll()
  };

  root.FBLikeChat = ChatAPI;
})(window);

/* ====== مثال للتشغيل ====== */
FBLikeChat.setSelf({id:"me_1", name:"أنا", avatar:"me.png"});
FBLikeChat.addUser({id:"u_2", name:"Shadow", avatar:"shadow.png"});
const thread = FBLikeChat.threadForDM("me_1","u_2");

/* تحديث قائمة الرسائل */
function renderMessages(){
  const msgs = FBLikeChat.getMessages(thread.id);
  const container = document.getElementById("message-list");
  container.innerHTML = "";
  msgs.forEach(m=>{
    const div = document.createElement("div");
    div.className = "message " + (m.from==="me_1"?"mine":"theirs");
    div.textContent = m.text;
    container.appendChild(div);
  });
}
renderMessages();

/* إرسال رسالة */
document.getElementById("sendBtn").onclick = ()=>{
  const text = document.getElementById("msgInput").value.trim();
  if(text){
    FBLikeChat.sendMessage({threadId:thread.id, text});
    document.getElementById("msgInput").value = "";
    renderMessages();
  }
};

</script>

</body>
</html>
